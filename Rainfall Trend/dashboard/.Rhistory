##rasterize output
R95pTOT_raster<-rasterize(pts,r[[1]],field="R95pTOT")
## Save raster
file_name <- paste0(save_url, "R95pTOT_1951.tif")
writeRaster(R95pTOT_raster, file_name, overwrite = TRUE)
cat("Saved:", file_name, "\n")
##plot raster file
tif.files<-list.files(save_url,pattern = "\\.tif$",full.names = TRUE)
tif.files
##Load them as a SpatRaster files
rasters<-lapply(tif.files,rast)
rasters<-rast(rasters)
# Plot with scientific color scale
plot(rasters,
main = "R95pTOT – 1951",
col = hcl.colors(30, "YlOrRd"))
read.csv(input$stationfile$datapath)
server <- function(input, output, session) {
## ----------------------Load Raster--------------------------
r_daily <- reactive({
req(input$ncfile)
rast(input$ncfile$datapath)
})
##------------------------Load CSV----------------------------
stations <- reactive({
req(input$stationfile)
read.csv(input$stationfile$datapath)
})
##--------------------------Extract the coordinates-----------------------------
pts <- reactive({
req(stations())
vect(stations(), geom = c("lon", "lat"), crs = crs(r_daily()))
})
observeEvent(stations(), {
updateSelectInput(session, "station", choices = stations()$station_id)
})
##-----------------------------Generate Daily Dates-----------------------
daily_dates <- reactive({
req(r_daily())
n <- nlyr(r_daily())
start_date <- as.Date("1951-01-01")
seq(start_date, by = "day", length.out = n)
})
##-----------------------------Meta Data-----------------------
output$meta <- renderPrint({
req(r_daily())
names(r_daily()) <- as.character(daily_dates())
r_daily()
})
##-----------------------------Aggregate to Monthly-----------------------
r_monthly <- reactive({
req(r_daily())
r <- r_daily()
dates <- daily_dates()
month_group <- format(dates, "%Y-%m")
r_m <- tapp(r, month_group, sum, na.rm = TRUE)
names(r_m) <- unique(month_group)
r_m
})
month_labels <- reactive({
req(r_monthly())
ym <- names(r_monthly())
pretty_names <- format(as.Date(paste0(ym, "-01")), "%B %Y")
names(pretty_names) <- ym
pretty_names
})
##-------------------------Dynamic UI---------------------------------
output$date_or_month_selector <- renderUI({
req(r_daily())
if (input$viewType == "daily") {
selectInput("selected_day", "Select Date:", choices = format(daily_dates(), "%Y-%m-%d"))
} else {
selectInput("selected_month", "Select Month:", choices = month_labels())
}
})
##-------------------------Render Map---------------------------------
output$map <- renderTmap({
req(r_daily())
if (input$viewType == "daily") {
req(input$selected_day)
idx <- which(format(daily_dates(), "%Y-%m-%d") == input$selected_day)
r_show <- r_daily()[[idx]]
title_txt <- paste("Daily Rainfall:", input$selected_day)
} else {
req(input$selected_month)
ym <- names(month_labels())[month_labels() == input$selected_month]
r_show <- r_monthly()[[ym]]
title_txt <- paste("Monthly Rainfall:", input$selected_month)
}
tm_shape(r_show) +
tm_raster(col.scale = tm_scale(values = "-Spectral"),
col.legend = tm_legend(title = title_txt)) +
tm_layout(legend.outside = TRUE)
})
##-------------------------Climate Indices Calculation-----------------
indices_calculate <- eventReactive(input$compute_index, {
req(r_daily(), input$climate_index, pts(), daily_dates())
r <- r_daily()
points <- pts()
dates <- daily_dates()
month_group <- format(dates, "%Y-%m")
unique_months <- unique(month_group)
result_list <- list()
##----------------------PRCPTOT--------------------------
if (input$climate_index == "PRCPTOT") {
req(input$threshold)
threshold <- as.numeric(input$threshold)
for (m in unique_months) {
month_idx <- which(month_group == m)
month_r <- r[[month_idx]]
vals <- extract(month_r, points)[,-1, drop = FALSE]
PRCPTOT_vals <- apply(vals, 1, function(x) sum(x[x >= threshold], na.rm = TRUE))
points$PRCPTOT <- PRCPTOT_vals
PRCPTOT_r <- rasterize(points, month_r[[1]], field = "PRCPTOT")
names(PRCPTOT_r) <- m
result_list[[m]] <- PRCPTOT_r
}
PRCPTOT_stack <- rast(result_list)
names(PRCPTOT_stack) <- unique_months
return(PRCPTOT_stack)
}
##----------------------CDD------------------------------
else if (input$climate_index == "CDD") {
req(input$threshold)
threshold <- as.numeric(input$threshold)
vals <- extract(r, points)[,-1, drop=FALSE]
CDD_fun <- function(daily_precip, threshold){
dry <- as.numeric(daily_precip) < threshold
dry[is.na(dry)] <- FALSE
if(all(!dry)) return(0)
rle_dry <- rle(dry)
max(rle_dry$lengths[rle_dry$values])
}
cdd_values <- apply(vals, 1, CDD_fun, threshold = threshold)
points$CDD <- cdd_values
CDD_raster <- rasterize(points, r[[1]], field = "CDD")
names(CDD_raster) <- "CDD"
return(CDD_raster)
}
##----------------------RxDday----------------------------
else if (input$climate_index == "RxDday") {
req(input$rolling_window)
roll_window <- as.numeric(input$rolling_window)
for (m in unique_months) {
month_idx <- which(month_group == m)
month_r <- r[[month_idx]]
vals <- extract(month_r, points)[,-1, drop=FALSE]
roll_sum <- apply(vals, 1, function(x){
if(length(x) >= roll_window){
max(zoo::rollapply(x, width=roll_window, FUN=sum, align="left", na.rm=TRUE))
} else NA
})
points$RxDday <- roll_sum
RxDday_raster <- rasterize(points, month_r[[1]], field = "RxDday")
names(RxDday_raster) <- m
result_list[[m]] <- RxDday_raster
}
RxDday_stack <- rast(result_list)
names(RxDday_stack) <- unique_months
return(RxDday_stack)
}
##----------------------Rnnmm----------------------------
else if (input$climate_index == "Rnnmm") {
req(input$threshold)
threshold <- as.numeric(input$threshold)
for (m in unique_months) {
month_idx <- which(month_group == m)
month_r <- r[[month_idx]]
vals <- extract(month_r, points)[,-1, drop=FALSE]
Rnnmm_vals <- apply(vals, 1, function(x) sum(x > threshold, na.rm=TRUE))
points$Rnnmm <- Rnnmm_vals
Rnnmm_raster <- rasterize(points, month_r[[1]], field = "Rnnmm")
names(Rnnmm_raster) <- m
result_list[[m]] <- Rnnmm_raster
}
Rnnmm_stack <- rast(result_list)
names(Rnnmm_stack) <- unique_months
return(Rnnmm_stack)
}
})
###---------------------------------------Month Selector for Indices-------------------------------
output$index_month_selector <- renderUI({
req(indices_calculate())
selectInput("selected_index_month", "Select Month to View:",
choices = names(indices_calculate()))
})
###---------------------------------------Output of Climate Indices-------------------------------
output$index_plot <- renderPlot({
req(indices_calculate(), input$selected_index_month)
r_stack <- indices_calculate()
month_name <- input$selected_index_month
plot(r_stack[[month_name]], main = month_name)
})
###-------------------------------------Download Button------------------------------------
output$download_index <- downloadHandler(
filename = function() {
paste0(input$climate_index, "_", input$selected_index_month, ".tif")
},
content = function(file) {
req(indices_calculate(), input$selected_index_month)
writeRaster(indices_calculate()[[input$selected_index_month]], file, overwrite = TRUE)
}
)
}
shiny::runApp()
cls
clear
shiny::runApp()
runApp()
##read the annual PRCPTOT percentile value in the file
annual_PRCPTOT <- readRDS("C:/Hydrology-Project/Rainfall Trend/scripts/annual_PRCPTOT.rds")
##read the R99p value in the file
R99p <- readRDS("C:/Hydrology-Project/Rainfall Trend/scripts/R99_threshold.rds")
library(terra)
##read the annual PRCPTOT percentile value in the file
annual_PRCPTOT <- readRDS("C:/Hydrology-Project/Rainfall Trend/scripts/annual_PRCPTOT.rds")
##read the R99p value in the file
R99p <- readRDS("C:/Hydrology-Project/Rainfall Trend/scripts/R99_threshold.rds")
annual_PRCPTOT
R99p
##read the R99p value in the file
R99 <- readRDS("C:/Hydrology-Project/Rainfall Trend/scripts/R99_threshold.rds")
R99
##read the R99p value in the file
R99<- readRDS("C:/Hydrology-Project/Rainfall Trend/scripts/R99_threshold.rds")
##read the 99th percentile value in the file
p99 <- readRDS("C:/Hydrology-Project/Rainfall Trend/scripts/p99_threshold.rds")
print(p99)  # check value
##import required libraries
library(terra)
##path of the nc file
url<-"C:/Hydrology-Project/Rainfall Trend/NCDF/rainfall_1951_daily.nc"
##path of the csv file
url_1<-"C:/Hydrology-Project/Rainfall Trend/CSV files/drf_1951_new2.csv"
##save output url
save_url<-"C:/Hydrology-Project/Rainfall Trend/indices/R99p/"
r<-rast(url) ##convert raster object
points<-read.csv(url_1) ##read csv file
pts<-vect(points,geom=c("lon","lat"),crs=crs(r)) ##convert the lat lon as the spatial locations
##Extract daily rainfall at point
rain_values<-terra::extract(r,pts)
##Remove ID column
rain_values<-rain_values[,-1]
##define the customize function
R99p<-function(daily_precip,threshold){
wet<-sum(daily_precip[as.numeric(daily_precip)>threshold])
return(wet)
}
##Apply above function for each station
extreme_wet_days<-apply(rain_values,1,R99p,threshold=p99)
pts$R99p<-extreme_wet_days
##rasterize output
R99p_raster<-rasterize(pts,r[[1]],field="R99p")
## Save raster
file_name <- paste0(save_url, "R99p_1951.tif")
writeRaster(R99p_raster, file_name, overwrite = TRUE)
cat("Saved:", file_name, "\n")
##plot raster file
tif.files<-list.files(save_url,pattern = "\\.tif$",full.names = TRUE)
##Load them as a SpatRaster files
rasters<-lapply(tif.files,rast)
rasters<-rast(rasters)
# Plot with scientific color scale
plot(rasters,
main = "R99p for 1951",
col = hcl.colors(30, "YlOrRd"))
# Save to files
saveRDS(extreme_wet_days,"C:/Hydrology-Project/Rainfall Trend/scripts/R99_threshold.rds")
library(terra)
##read the annual PRCPTOT percentile value in the file
annual_PRCPTOT <- readRDS("C:/Hydrology-Project/Rainfall Trend/scripts/annual_PRCPTOT.rds")
##read the R99p value in the file
R99<- readRDS("C:/Hydrology-Project/Rainfall Trend/scripts/R99_threshold.rds")
R99
extreme_wet_days
library(terra)
##read the annual PRCPTOT percentile value in the file
annual_PRCPTOT <- readRDS("C:/Hydrology-Project/Rainfall Trend/scripts/annual_PRCPTOT.rds")
##read the R99p value in the file
R99<- readRDS("C:/Hydrology-Project/Rainfall Trend/scripts/R99_threshold.rds")
R99
##path of the nc file
url<-"C:/Hydrology-Project/Rainfall Trend/NCDF/rainfall_1951_daily.nc"
##path of the csv file
url_1<-"C:/Hydrology-Project/Rainfall Trend/CSV files/drf_1951_new2.csv"
##save output url
save_url<-"C:/Hydrology-Project/Rainfall Trend/indices/R99pTOT/"
r<-rast(url) ##convert raster object
points<-read.csv(url_1) ##read csv file
pts<-vect(points,geom=c("lon","lat"),crs=crs(r)) ##convert the lat lon as the spatial locations
##calculate the indices
R99pTOT<-(100*R99)/annual_PRCPTOT
pts$R99pTOT<-R99pTOT
##rasterize output
R99pTOT_raster<-rasterize(pts,r[[1]],field="R99pTOT")
## Save raster
file_name <- paste0(save_url, "R99pTOT_1951.tif")
writeRaster(R99pTOT_raster, file_name, overwrite = TRUE)
cat("Saved:", file_name, "\n")
##R99pTOT indices
library(terra)
##read the annual PRCPTOT percentile value in the file
annual_PRCPTOT <- readRDS("C:/Hydrology-Project/Rainfall Trend/scripts/annual_PRCPTOT.rds")
##read the R99p value in the file
R99<- readRDS("C:/Hydrology-Project/Rainfall Trend/scripts/R99_threshold.rds")
##path of the nc file
url<-"C:/Hydrology-Project/Rainfall Trend/NCDF/rainfall_1951_daily.nc"
##path of the csv file
url_1<-"C:/Hydrology-Project/Rainfall Trend/CSV files/drf_1951_new2.csv"
##save output url
save_url<-"C:/Hydrology-Project/Rainfall Trend/indices/R99pTOT/"
r<-rast(url) ##convert raster object
points<-read.csv(url_1) ##read csv file
pts<-vect(points,geom=c("lon","lat"),crs=crs(r)) ##convert the lat lon as the spatial locations
##calculate the indices
R99pTOT<-(100*R99)/annual_PRCPTOT
pts$R99pTOT<-R99pTOT
##rasterize output
R99pTOT_raster<-rasterize(pts,r[[1]],field="R99pTOT")
## Save raster
file_name <- paste0(save_url, "R99pTOT_1951.tif")
writeRaster(R99pTOT_raster, file_name, overwrite = TRUE)
cat("Saved:", file_name, "\n")
##plot raster file
tif.files<-list.files(save_url,pattern = "\\.tif$",full.names = TRUE)
##Load them as a SpatRaster files
rasters<-lapply(tif.files,rast)
rasters<-rast(rasters)
# Plot with scientific color scale
plot(rasters,
main = "R99pTOT – 1951",
col = hcl.colors(30, "YlOrRd"))
runApp()
##import required libraries
library(terra)
##path of the nc file
url<-"C:/Hydrology-Project/Rainfall Trend/NCDF/rainfall_1951_daily.nc"
##path of the csv file
url_1<-"C:/Hydrology-Project/Rainfall Trend/CSV files/drf_1951_new2.csv"
##save output url
save_url<-"C:/Hydrology-Project/Rainfall Trend/indices/CWD_1951/"
r<-rast(url) ##convert raster object
r
dates<-as.Date(time(r)) ##time range 1951-01-01 to 1951-12-31
dates
tif_url<-"C:/Hydrology-Project/Rainfall Trend/yearly-rasters/rainfall_1951_day_tif/rainfall_1951_day_1.tif"
r1<-rast(tif_url)
r1
time<-as.Date(time(r1))
time
##import required libraries
library(terra)
##path of the nc file
url<-"C:/Hydrology-Project/Rainfall Trend/NCDF/rainfall_1951_daily.nc"
##path of the csv file
url_1<-"C:/Hydrology-Project/Rainfall Trend/CSV files/drf_1951_new2.csv"
##save output url
save_url<-"C:/Hydrology-Project/Rainfall Trend/indices/CDD_1951/"
r<-rast(url) ##convert raster object
points<-read.csv(url_1) ##read csv file
pts<-vect(points,geom=c("lon","lat"),crs=crs(r)) ##convert the lat lon as the spatial locations
tvals <- terra::time(r)
tvals
library(terra)
# Loop through all years 1951 to 1981
for (year in 1951:1981) {
# Define raster folder
folder <- paste0("C:/Hydrology-Project/Rainfall Trend/yearly-rasters/rainfall_", year, "_day_tif/")
# List all daily raster files
files <- list.files(folder, pattern = "\\.tif$", full.names = TRUE)
# Extract numeric day index
day_numbers <- as.numeric(gsub(".*day_([0-9]+)\\.tif$", "\\1", basename(files)))
# Order files numerically
files <- files[order(day_numbers)]
# Read all rasters as a SpatRaster
r_stack <- rast(files)
# Create correct date sequence
dates <- seq(as.Date(paste0(year, "-01-01")), as.Date(paste0(year, "-12-31")), by="day")
# Write NetCDF — include time here, not in SpatRaster
out_nc <- paste0("C:/Hydrology-Project/Rainfall Trend/NCDF/rainfall_", year, "_daily.nc")
writeCDF(r_stack,
filename = out_nc,
overwrite = TRUE,
varname = "precip_day",
unit = "mm/day",
longname = "Daily precipitation",
time = dates,
tname = "time",
tunits = "days since 1950-01-01",
compression = 4)
cat("Created NetCDF for year:", year, "\n")
}
cat("All NetCDF files created successfully!\n")
##path of the nc file
url<-"C:/Hydrology-Project/Rainfall Trend/NCDF/rainfall_1951_daily.nc"
##path of the csv file
url_1<-"C:/Hydrology-Project/Rainfall Trend/CSV files/drf_1951_new2.csv"
##save output url
save_url<-"C:/Hydrology-Project/Rainfall Trend/indices/Rnnmm/"
r<-rast(url) ##convert raster object
dates<-as.Date(time(r)) ##time range 1951-01-01 to 1951-12-31
dates
(as.Date(paste0(1951, "-01-01")), as.Date(paste0(1951, "-12-31")), by="day")
dates <- seq(as.Date(paste0(1951, "-01-01")), as.Date(paste0(1951, "-12-31")), by="day")
dates
dates <- seq(as.Date(paste0(1952, "-01-01")), as.Date(paste0(1952, "-12-31")), by="day")
dates
library(terra)
library(ncdf4)
# Loop through all years 1951 to 1981
for (year in 1951:1981) {
# Define raster folder
folder <- paste0("C:/Hydrology-Project/Rainfall Trend/yearly-rasters/rainfall_", year, "_day_tif/")
# List all daily raster files
files <- list.files(folder, pattern = "\\.tif$", full.names = TRUE)
# Extract numeric day index
day_numbers <- as.numeric(gsub(".*day_([0-9]+)\\.tif$", "\\1", basename(files)))
# Order files numerically
files <- files[order(day_numbers)]
# Read all rasters as a SpatRaster
r_stack <- rast(files)
# Create correct date sequence
dates <- seq(as.Date(paste0(year, "-01-01")), as.Date(paste0(year, "-12-31")), by="day")
# Write NetCDF — include time here, not in SpatRaster
out_nc <- paste0("C:/Hydrology-Project/Rainfall Trend/NCDF/rainfall_", year, "_daily.nc")
writeCDF(r_stack,
filename = out_nc,
overwrite = TRUE,
varname = "precip_day",
unit = "mm/day",
longname = "Daily precipitation",
time = dates,
tname = "time",
tunits = "days since 1950-01-01",
compression = 4)
cat("Created NetCDF for year:", year, "\n")
}
cat("All NetCDF files created successfully!\n")
##path of the nc file
url<-"C:/Hydrology-Project/Rainfall Trend/NCDF/rainfall_1951_daily.nc"
##path of the csv file
url_1<-"C:/Hydrology-Project/Rainfall Trend/CSV files/drf_1951_new2.csv"
##save output url
save_url<-"C:/Hydrology-Project/Rainfall Trend/indices/CWD_1951/"
r<-rast(url) ##convert raster object
dates<-as.Date(time(r)) ##time range 1951-01-01 to 1951-12-31
dates
##path of the nc file
url<-"C:/Hydrology-Project/Rainfall Trend/yearly-rasters/rainfall_1954_day_tif/rainfall_1954_day_1.tif"
r<-rast(url)
time(r)
library(ncdf4)
##import required libraries
library(terra)
##path of the nc file
url<-"C:/Hydrology-Project/Rainfall Trend/NCDF/rainfall_1951_daily.nc"
##path of the csv file
url_1<-"C:/Hydrology-Project/Rainfall Trend/CSV files/drf_1951_new2.csv"
##save output url
save_url<-"C:/Hydrology-Project/Rainfall Trend/indices/CWD_1951/"
r<-readCDF(url) ##convert raster object
##path of the nc file
url<-"C:/Hydrology-Project/Rainfall Trend/NCDF/rainfall_1951_daily.nc"
##path of the csv file
url_1<-"C:/Hydrology-Project/Rainfall Trend/CSV files/drf_1951_new2.csv"
##save output url
save_url<-"C:/Hydrology-Project/Rainfall Trend/indices/CWD_1951/"
r<-rast(url) ##convert raster object
dates<-as.Date(time(r)) ##time range 1951-01-01 to 1951-12-31
nlyr(r)
r
library(terra)
# Loop through all years 1951 to 1981
for (year in 1951:1981) {
# Define raster folder
folder <- paste0("C:/Hydrology-Project/Rainfall Trend/yearly-rasters/rainfall_", year, "_day_tif/")
# List all daily raster files
files <- list.files(folder, pattern = "\\.tif$", full.names = TRUE)
# Extract numeric day index
day_numbers <- as.numeric(gsub(".*day_([0-9]+)\\.tif$", "\\1", basename(files)))
# Order files numerically
files <- files[order(day_numbers)]
# Read all rasters as a SpatRaster
r_stack <- rast(files)
# Create correct date sequence
dates <- seq(as.Date(paste0(year, "-01-01")), as.Date(paste0(year, "-12-31")), by="day")
# Write NetCDF — include time here, not in SpatRaster
out_nc <- paste0("C:/Hydrology-Project/Rainfall Trend/NCDF/rainfall_", year, "_daily.nc")
writeCDF(r_stack,
filename = out_nc,
overwrite = TRUE,
varname = "Day_",
unit = "mm/day",
longname = "Daily precipitation",
time = dates,
tname = "time",
tunits = "days since 1950-01-01",
compression = 4)
cat("Created NetCDF for year:", year, "\n")
}
cat("All NetCDF files created successfully!\n")
##path of the nc file
url<-"C:/Hydrology-Project/Rainfall Trend/NCDF/rainfall_1951_daily.nc"
##path of the csv file
url_1<-"C:/Hydrology-Project/Rainfall Trend/CSV files/drf_1951_new2.csv"
##save output url
save_url<-"C:/Hydrology-Project/Rainfall Trend/indices/CWD_1951/"
r<-rast(url) ##convert raster object
r
dates<-as.Date(time(r)) ##time range 1951-01-01 to 1951-12-31
dates
shiny::runApp()
