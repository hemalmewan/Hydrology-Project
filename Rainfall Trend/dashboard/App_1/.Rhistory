rx_dir <- paste0(output_dir, "Rx", d, "day_", year, "/")
dir.create(rx_dir, showWarnings = FALSE)
for(month in 1:12){
monthly_index <- which(format(dates, "%m") == sprintf("%02d", month))
vals <- as.matrix(extract(r[[monthly_index]], pts)[,-1,drop=FALSE])
if(ncol(vals) >= d){
roll_sum <- t(apply(vals, 1, function(x) rollapply(x, width=d, sum, align="left", na.rm=TRUE)))
rx_vals <- apply(roll_sum, 1, max, na.rm=TRUE)
} else {
rx_vals <- rep(NA, nrow(vals))
}
pts$Rxdday <- rx_vals
out_r <- rasterize(pts, r[[1]], field="Rxdday")
fname <- paste0(rx_dir, "Rx", d, "day_", year, "_", sprintf("%02d", month), ".tif")
writeRaster(out_r, fname, overwrite=TRUE)
cat("Saved:", fname, "\n")
}
}
##----------------------RUN PIPELINE---------------------
compute_PRCPTOT()
compute_Rxdday(d)
compute_CDD()
cat("\n Pipeline Completed Successfully.\n")
##input the year
year<-as.integer(readline("Enter Year (e.g, 1951) :"))
cat("Selected Year:", year, "\n")
##input rolling window
d <- as.integer(readline("Enter Rolling Window n (1-10): "))
stopifnot(d >= 1 & d <= 10)
##path of the nc file
url<-"C:/Hydrology-Project/Rainfall Trend/NCDF/"
##path of the csv file
url_1<-"C:/Hydrology-Project/Rainfall Trend/CSV files/"
##output directory
output_dir <- "C:/Hydrology-Project/Rainfall Trend/indices/"
## Build file names dynamically based on year
nc_file <- paste0(url, "rainfall_", year, "_daily.nc")
station_csv <- paste0(url_1, "drf_", year, "_new2.csv")
dir.create(output_dir, showWarnings = FALSE)
## --- LOAD DATA ---
r<-rast(nc_file) ##convert raster object
dates<-as.Date(time(r)) ##time range 1951-01-01 to 1951-12-31
points<-read.csv(station_csv) ##read csv file
pts<-vect(points,geom=c("lon","lat"),crs=crs(r)) ##convert the lat lon as the spatial locations
threshold <- 1   # rainfall threshold for PRCPTOT & CDD
##define the customize function for CDD climate indices
compute_CDD <- function(){
vals <- extract(r, pts)[,-1]
CDD <- function(x){
dry <- as.numeric(x) < threshold
if(all(!dry)) return(0)
runs <- rle(dry)
max(runs$lengths[runs$values])
}
cdd_vals <- apply(vals, 1, CDD)
pts$CDD <- cdd_vals
cdd_dir <- paste0(output_dir, "CDD_", year, "/")
dir.create(cdd_dir, showWarnings = FALSE)
fname <- paste0(cdd_dir, "CDD_", year, ".tif")
writeRaster(rasterize(pts, r[[1]], field="CDD"), fname, overwrite=TRUE)
cat("Saved:", fname, "\n")
}
##define the customize function for PRCPTOT climate indices
compute_PRCPTOT <- function() {
prcp_dir <- paste0(output_dir, "PRCPTOT_", year, "/")
dir.create(prcp_dir, showWarnings = FALSE)
for(month in 1:12){
monthly_index <- which(format(dates, "%m") == sprintf("%02d", month))
vals <- extract(r[[monthly_index]], pts)[,-1, drop=FALSE]
prcptot <- apply(vals, 1, function(x) sum(x[x >= threshold], na.rm = TRUE))
pts$PRCPTOT <- prcptot
PRCPTOT_raster <- rasterize(pts, r[[1]], field="PRCPTOT")
fname <- paste0(prcp_dir, "PRCPTOT_", year, "_", sprintf("%02d", month), ".tif")
writeRaster(PRCPTOT_raster,fname, overwrite=TRUE)
cat("Saved:", fname, "\n")
}
}
##define the customize function for Rxdday climate indices
compute_Rxdday <- function(d){
rx_dir <- paste0(output_dir, "Rx", d, "day_", year, "/")
dir.create(rx_dir, showWarnings = FALSE)
for(month in 1:12){
monthly_index <- which(format(dates, "%m") == sprintf("%02d", month))
vals <- as.matrix(extract(r[[monthly_index]], pts)[,-1,drop=FALSE])
if(ncol(vals) >= d){
roll_sum <- t(apply(vals, 1, function(x) rollapply(x, width=d, sum, align="left", na.rm=TRUE)))
rx_vals <- apply(roll_sum, 1, max, na.rm=TRUE)
} else {
rx_vals <- rep(NA, nrow(vals))
}
pts$Rxdday <- rx_vals
out_r <- rasterize(pts, r[[1]], field="Rxdday")
fname <- paste0(rx_dir, "Rx", d, "day_", year, "_", sprintf("%02d", month), ".tif")
writeRaster(out_r, fname, overwrite=TRUE)
cat("Saved:", fname, "\n")
}
}
##----------------------RUN PIPELINE---------------------
compute_PRCPTOT()
compute_Rxdday(d)
compute_CDD()
##import required libraries
library(terra)
library(zoo)
##input the year
year<-as.integer(readline("Enter Year (e.g, 1951) :"))
cat("Selected Year:", year, "\n")
##input rolling window
d <- as.integer(readline("Enter Rolling Window n (1-10): "))
stopifnot(d >= 1 & d <= 10)
##path of the nc file
url<-"C:/Hydrology-Project/Rainfall Trend/NCDF/"
##path of the nc file
url<-"C:/Hydrology-Project/Rainfall Trend/NCDF/"
##path of the csv file
url_1<-"C:/Hydrology-Project/Rainfall Trend/CSV files/"
##output directory
output_dir <- "C:/Hydrology-Project/Rainfall Trend/indices/"
## Build file names dynamically based on year
nc_file <- paste0(url, "rainfall_", year, "_daily.nc")
station_csv <- paste0(url_1, "drf_", year, "_new2.csv")
dir.create(output_dir, showWarnings = FALSE)
## --- LOAD DATA ---
r<-rast(nc_file) ##convert raster object
dates<-as.Date(time(r)) ##time range 1951-01-01 to 1951-12-31
points<-read.csv(station_csv) ##read csv file
pts<-vect(points,geom=c("lon","lat"),crs=crs(r)) ##convert the lat lon as the spatial locations
threshold <- 1   # rainfall threshold for PRCPTOT & CDD
##define the customize function for CDD climate indices
compute_CDD <- function(){
vals <- extract(r, pts)[,-1]
CDD <- function(x){
dry <- as.numeric(x) < threshold
dry[is.na(dry)]<-FALSE ##handle missing values
if(all(!dry)) return(0) ##if no rainy days
runs <- rle(dry)
max(runs$lengths[runs$values])
}
cdd_vals <- apply(vals, 1, CDD)
pts$CDD <- cdd_vals
cdd_dir <- paste0(output_dir, "CDD_", year, "/")
dir.create(cdd_dir, showWarnings = FALSE)
fname <- paste0(cdd_dir, "CDD_", year, ".tif")
writeRaster(rasterize(pts, r[[1]], field="CDD"), fname, overwrite=TRUE)
cat("Saved:", fname, "\n")
}
##define the customize function for PRCPTOT climate indices
compute_PRCPTOT <- function() {
prcp_dir <- paste0(output_dir, "PRCPTOT_", year, "/")
dir.create(prcp_dir, showWarnings = FALSE)
for(month in 1:12){
monthly_index <- which(format(dates, "%m") == sprintf("%02d", month))
vals <- extract(r[[monthly_index]], pts)[,-1, drop=FALSE]
prcptot <- apply(vals, 1, function(x) sum(x[x >= threshold], na.rm = TRUE))
pts$PRCPTOT <- prcptot
PRCPTOT_raster <- rasterize(pts, r[[1]], field="PRCPTOT")
fname <- paste0(prcp_dir, "PRCPTOT_", year, "_", sprintf("%02d", month), ".tif")
writeRaster(PRCPTOT_raster,fname, overwrite=TRUE)
cat("Saved:", fname, "\n")
}
}
##define the customize function for Rxdday climate indices
compute_Rxdday <- function(d){
rx_dir <- paste0(output_dir, "Rx", d, "day_", year, "/")
dir.create(rx_dir, showWarnings = FALSE)
for(month in 1:12){
monthly_index <- which(format(dates, "%m") == sprintf("%02d", month))
vals <- as.matrix(extract(r[[monthly_index]], pts)[,-1,drop=FALSE])
if(ncol(vals) >= d){
roll_sum <- t(apply(vals, 1, function(x) rollapply(x, width=d, sum, align="left", na.rm=TRUE)))
rx_vals <- apply(roll_sum, 1, max, na.rm=TRUE)
} else {
rx_vals <- rep(NA, nrow(vals))
}
pts$Rxdday <- rx_vals
out_r <- rasterize(pts, r[[1]], field="Rxdday")
fname <- paste0(rx_dir, "Rx", d, "day_", year, "_", sprintf("%02d", month), ".tif")
writeRaster(out_r, fname, overwrite=TRUE)
cat("Saved:", fname, "\n")
}
}
##----------------------RUN PIPELINE---------------------
compute_PRCPTOT()
compute_Rxdday(d)
compute_CDD()
cat("\n Pipeline Completed Successfully.\n")
####--------------------------------------PLOT THESE INDICES----------------------------------
output_dir
install.packages("tmap")
output_dir
paste0(output_dir,"/","Rx5day_1951/Rx5day_1951_08.tif")
paste0(output_dir,"/","Rx1day_1951/Rx1day_1951_08.tif")
paste0(output_dir,"Rx1day_1951/Rx1day_1951_08.tif")
library(tmap)
r <- rast(paste0(output_dir,"Rx1day_1951/Rx1day_1951_08.tif"))   # Example
r
tm_shape(r) +
tm_raster(palette = "-Spectral", title = "Rx5day (Aug 1951)") +
tm_layout(legend.outside = TRUE)
tm_shape(r) +
tm_raster(palette = "-Spectral", title = "Rx1day (Aug 1951)") +
tm_layout(legend.outside = TRUE)
year
index <- "Rx1day"
for(month in 1:12){
file <- paste0(output_dir, index, "_", year, "/", index, "_", year, "_", sprintf("%02d", month), ".tif")
r <- rast(file)
print(
tm_shape(r) +
tm_raster(palette = "-Spectral", title = paste0(index, " (", month.abb[month], " ", year, ")")) +
tm_layout(legend.outside = TRUE)
)
}
par(mfrow=c(4,3))
for(month in 1:12){
file <- paste0(output_dir, index, "_", year, "/", index, "_", year, "_", sprintf("%02d", month), ".tif")
r <- rast(file)
print(
tm_shape(r) +
tm_raster(palette = "-Spectral", title = paste0(index, " (", month.abb[month], " ", year, ")")) +
tm_layout(legend.outside = TRUE)
)
}
##----------------------------PRCPTOT----------------------------------------------
index<-"PRCPTOT"
output_dir
for(month in 1:12){
file <- paste0(output_dir, index, "_", year, "/", index, "_", year, "_", sprintf("%02d", month), ".tif")
r <- rast(file)
print(
tm_shape(r) +
tm_raster(palette = "-Spectral", title = paste0(index, " (", month.abb[month], " ", year, ")")) +
tm_layout(legend.outside = TRUE)
)
}
paste0(output_dir, index, "_", year, "/", index, "_", year, "_", sprintf("%02d",1), ".tif")
##----------------------------CDD---------------------------------------------------
index<-"CDD"
for(month in 1:12){
file <- paste0(output_dir, index, "_", year, "/", index, "_", year, "_", sprintf("%02d", month), ".tif")
r <- rast(file)
print(
tm_shape(r) +
tm_raster(palette = "-Spectral", title = paste0(index, " (", month.abb[month], " ", year, ")")) +
tm_layout(legend.outside = TRUE)
)
}
paste0(output_dir, index, "_", year, "/", index, "_", year, "_", sprintf("%02d", month), ".tif")
paste0(output_dir, index, "_", year, "/", index, "_", year, "_", ".tif")
paste0(output_dir, index, "_", year, "/", index, "_", year, ".tif")
##----------------------------CDD---------------------------------------------------
index<-"CDD"
for(month in 1:12){
file <- paste0(output_dir, index, "_", year, "/", index, "_", year, ".tif")
r <- rast(file)
print(
tm_shape(r) +
tm_raster(palette = "-Spectral", title = paste0(index, " (", month.abb[month], " ", year, ")")) +
tm_layout(legend.outside = TRUE)
)
}
##----------------------------CDD---------------------------------------------------
index<-"CDD"
file <- paste0(output_dir, index, "_", year, "/", index, "_", year, ".tif")
r <- rast(file)
print(
tm_shape(r) +
tm_raster(palette = "-Spectral", title = paste0(index,year, ")")) +
tm_layout(legend.outside = TRUE)
)
print(
tm_shape(r) +
tm_raster(palette = "-Spectral", title = paste0(index,"(".year, ")")) +
##----------------------------CDD---------------------------------------------------
index<-"CDD"
file <- paste0(output_dir, index, "_", year, "/", index, "_", year, ".tif")
r <- rast(file)
print(
tm_shape(r) +
tm_raster(palette = "-Spectral", title = paste0(index,"(",year, ")")) +
tm_layout(legend.outside = TRUE)
)
library(shiny)
install.packages("shiny")
install.packages("shinydashboard")
library(shiny)
library(shinydashboard)
library(tmap)
library(terra)
ui <- dashboardPage(
dashboardHeader(title = "Climate Indices Dashboard"),
dashboardSidebar(
numericInput("year", "Select Year:", value = 1951, min = 1951, max = 2100),
selectInput("month", "Select Month:", choices = 1:12),
selectInput("index", "Select Index:", choices = c("PRCPTOT", "Rxdday", "CDD")),
actionButton("run_pipeline", "Compute Indices")
),
dashboardBody(
tmapOutput("map")
)
)
runApp('C:/Hydrology-Project/Rainfall Trend/dashboard')
##input the year
year<-as.integer(readline("Enter Year (e.g, 1951) :"))
cat("Selected Year:", year, "\n")
##path of the nc file
url<-"C:/Hydrology-Project/Rainfall Trend/NCDF/"
## Build file names dynamically based on year
nc_file <- paste0(url, "rainfall_", year, "_daily.nc")
## --- LOAD DATA ---
r<-rast(nc_file) ##convert raster object
dates<-as.Date(time(r)) ##time range 1951-01-01 to 1951-12-31
r
dates
library(tmap)
tm_shape(r[[1:10]]) + tm_raster()
tm_shape(r[[1:14]]) + tm_raster()
r[[1]]
values(r[[1]])
val<-values(r[[1]])
is.na(val)
val[is.na(val)]
sum(val[is.na(val)])
sum(val[is.na(val)])
sum(is.na(val))
na_count<-sapply(1:nlyr(r), function(i){
sum(is.na(values(r[[i]])))
})
summary(na_count)
plot(na_counts, type="l", main="NA counts per day", ylab="Number of NA cells", xlab="Day")
plot(na_count, type="l", main="NA counts per day", ylab="Number of NA cells", xlab="Day")
na_count
length(na_count)
summary(na_count)
##check the extent
extent_check<-all(sapply(1:nlyr(r), function(i) extent(r[[i]])==extent(r[[i]])))
##check the extent
extent_check<-all(sapply(1:nlyr(r), function(i) ext(r[[i]])==ext(r[[i]])))
print(extent_check)
##check the resolution
res_check<-all(sapply(1:nlyrZ(r),function(i) res(r[[r]])==res(r[[i]])))
##check the resolution
res_check<-all(sapply(1:nlyr(r),function(i) res(r[[r]])==res(r[[i]])))
##check the resolution
res_check<-all(sapply(1:nlyr(r),function(i) res(r[[i]])==res(r[[i]])))
print(res_check)
summary_stat<-t(stats)
stats<-sapply(1:nlry(r),function(i){
vals<-values(r[[i]])
c(min=min(vals,na.rm=TRUE),
max=max(vals,na.rm=TRUE),
mean=mean(vals,na.rm=TRUE))
})
stats<-sapply(1:nlyr(r),function(i){
vals<-values(r[[i]])
c(min=min(vals,na.rm=TRUE),
max=max(vals,na.rm=TRUE),
mean=mean(vals,na.rm=TRUE))
})
summary_stat<-t(stats)
summary_stat
head(summary_stat)
##check outliers
suspicious_cell<-sapply(1:nlyr(r), function(i){
vals<-valueBox(r[[i]])
which(vals<0) ## negative
})
##check outliers
suspicious_cell<-sapply(1:nlyr(r), function(i){
vals<-values(r[[i]])
which(vals<0) ## negative
})
# Count suspicious cells per day
sapply(suspicious_cells, length)
# Count suspicious cells per day
sapply(suspicious_cell, length)
head(summary_stat)
head(summary_stat)
r[[1]]
values(r[[1]])
head(summary_stat)
##---------------------------------------Count the number of raster layers-------------------------------
print(nlyr(r))
r
##----------------------------------------------------Meta Data---------------------------
print(r)
##import required libraries
library(terra)
library(zoo)
##get the user input
paste("Enter the Required d value:",d<-as.integer(readline()))
print(d)
##validate the range of the d value it should be between 1 to 10
if(d<1 | d>10){
print("Error!!,d must be between 1 and 10")
}
##path of the nc file
url<-"C:/Hydrology-Project/Rainfall Trend/NCDF/rainfall_1951_daily.nc"
##path of the csv file
url_1<-"C:/Hydrology-Project/Rainfall Trend/CSV files/drf_1951_new2.csv"
##save output url
save_url<-"C:/Hydrology-Project/Rainfall Trend/indices/Rx1day_1951/"
r<-rast(url) ##convert raster object
dates<-as.Date(time(r)) ##time range 1951-01-01 to 1951-12-31
r
dates
points<-read.csv(url_1) ##read csv file
pts<-vect(points,geom=c("lon","lat"),crs=crs(r)) ##convert the lat lon as the spatial locations
##loop through all the months January to December
for (month in 1:12) {
##define end date and start date for each month
monthly_index<-which(format(dates,"%m")==sprintf("%02d",month))
##Daily precipitation data for each month
monthly_precipitation<-r[[monthly_index]]
##Daily precipitation data in each month each location
vals<-extract(monthly_precipitation,pts)
vals_mat<-as.matrix(vals[,-1,drop=FALSE]) ##remove ID column
## Compute the rolling window days
if(ncol(vals_mat) >= d){
roll_sum <- apply(vals_mat, 1, function(x) rollapply(x, width = d, FUN = sum, align = "left", na.rm = TRUE))
roll_sum <- as.matrix(roll_sum)
monthly_Rxdday <- apply(roll_sum, 2, max, na.rm = TRUE)
}else{
monthly_Rxdday <- rep(NA, nrow(vals))
}
##Attach the result as points
pts$Rxdday<-monthly_Rxdday
##create the raster layers
templete<-monthly_precipitation[[1]]
Rxdday_raster<-rasterize(pts,templete,field="Rxdday")
##Save raster
file_name<-paste0(save_url,"Rx",d,"day_1951_",sprintf("%02d",month),".tif")
writeRaster(Rxdday_raster,file_name,overwrite=TRUE)
}
##plot these 12 raster files
tif.files<-list.files(save_url,pattern = "\\.tif$",full.names = TRUE)
tif.files
# Extract month number from file names
months <- as.numeric(gsub(".*_(\\d+)\\.tif$", "\\1", basename(tif.files)))
# Order files by month number
tif.files <- tif.files[order(months)]
##Load them as a SpatRaster files
rasters<-lapply(tif.files,rast)
rasters
rasters<-rast(rasters)
library(terra)
library(viridis)
val_range <- range(values(rasters), na.rm = TRUE)
par(mfrow = c(4, 3),
mar = c(2, 2, 3, 2),
oma = c(0, 0, 4, 0))
month_names <- month.abb
for (i in 1:12) {
plot(rasters[[i]], col = viridis(30), zlim = val_range,
main = paste("Rx1day (1951) -", month_names[i]),
axes = FALSE, box = FALSE)
}
mtext("Monthly Maximum 1-Day Rainfall (Rx1day) — Year 1951",
outer = TRUE, cex = 1.5, font = 2)
shiny::runApp('C:/Hydrology-Project/Rainfall Trend/dashboard')
shiny::runApp('C:/Hydrology-Project/Rainfall Trend/dashboard')
runApp('C:/Hydrology-Project/Rainfall Trend/dashboard')
##path of the nc file
url<-"C:/Hydrology-Project/Rainfall Trend/NCDF/rainfall_1951_daily.nc"
library(terra)
library(terra)
##path of the nc file
url<-"C:/Hydrology-Project/Rainfall Trend/NCDF/rainfall_1951_daily.nc"
r<-rast(url)
r
r[[1]]
# Plot with scientific color scale
plot(r[[1]],
main = "Consecutive Dry Days (CDD) – 1951",
col = hcl.colors(30, "YlOrRd"))
runApp('C:/Hydrology-Project/Rainfall Trend/dashboard/App_1')
shiny::runApp()
##path of the nc file
url<-"C:/Hydrology-Project/Rainfall Trend/NCDF/rainfall_1951_daily.nc"
r<-rast(url) ##convert raster object
dates<-as.Date(time(r)) ##time range 1951-01-01 to 1951-12-31
dates
names(r)
r
terra::describe(url)
library(ncdf4)
nc <- ncdf4::nc_open(url)
nc$dim$time
r<-rast(url) ##convert raster object
dates <- seq(as.Date("1951-01-01"), as.Date("1951-12-31"), by = "day")
time(r) <- dates
class(r)
dates <- seq(as.Date("1951-01-01"), as.Date("1951-12-31"), by = "day")
names(r) <- as.character(dates)
dates<-as.Date(time(r)) ##time range 1951-01-01 to 1951-12-31
dates
dates <- seq(as.Date("1951-01-01"), as.Date("1951-12-31"), by = "day")
dates
names(r) <- as.character(dates)
r
dates<-as.Date(time(r)) ##time range 1951-01-01 to 1951-12-31
dates
dates<-as.Date(names(r)) ##time range 1951-01-01 to 1951-12-31
dates
runApp('C:/Hydrology-Project/Rainfall Trend/dashboard')
###---------------------------------------Month Selector for Indices-------------------------------
output$index_month_selector <- renderUI({
req(indices_calculate())
selectInput("selected_index_month", "Select Month to View:",
choices = names(indices_calculate()))
})
source("C:/Hydrology-Project/Rainfall Trend/dashboard/app.R", echo = TRUE)
